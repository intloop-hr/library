<meta name=format-detection content=telephone=no>
<meta name=viewport content=width=device-width>
<title>INTLOOPライブラリー 申請フォーム</title>
<link href=style.css rel=stylesheet>
<style>:not(*>*)>:where(body){inline-size:min(640px - 2rlh + 2rem,100% - 2rlh + 2rem);margin-inline:auto;padding-block:calc(.5rlh - .5rem);padding-inline:calc(1rlh - 1rem)}</style>

<script type=module>
const[form]=document.forms
const digits=new URLSearchParams(location.search).get('digits')
form.digits.value=digits

if(/^978\d{9}$|^979\d{9}$|^491\d{9}$/.test(digits)){
} else{
	form.digits.classList.add('invalid')

	if(document.hasFocus()){
	} else{
		const{resolve,promise}=Promise.withResolvers()
		addEventListener('focus',resolve)
		await promise
	}

	do{
		const{resolve,promise}=Promise.withResolvers()
		addEventListener('pageshow',resolve)
		await promise

		if('requestIdleCallback'in window){
			await new Promise(requestIdleCallback)
		}
		alert('URLのパラメーター digits が不正です。')
		history.back()
	} while(true)
}
</script>

<script type=module>
const decoder=new TextDecoder('sjis')
let usableLetters='\\s\'\\-a-z々あいうえお-ろわ-んゝゞァ-ロワ-ヴーヽヾ'
for(let number=0x8800;number<0xec00;++number){
	const array=[]
	let number_2=number
	while(number_2){
		array.unshift(--number_2%0x100)
		number_2>>=0x8
	}
	const uint8Array=new Uint8Array(array)
	const text=decoder.decode(uint8Array)

	if(text.codePointAt()<0x4e00) continue
	if(text.codePointAt()>=0xa000) continue

	usableLetters+=text
}
const invalidPattern=new RegExp('^\\s*\\S*\\s*$|[^'+usableLetters+']')

const{resolve,promise}=Promise.withResolvers()
addEventListener('pageshow',resolve)
await promise

const[form]=document.forms
form.date.value||=new Date().toLocaleDateString('sv')

do{
	switch(true){
		case invalidPattern.test(form.userName.value):
		form.userName.classList.add('invalid')
		break
		default:
		form.userName.classList.remove('invalid')
		if(form.userName.classList.length) break
		form.userName.removeAttribute('class')
	}

	switch(true){
		case form.date.value=='':
		case new Date(form.date.value+'T00:00')>new Date:
		form.date.classList.add('invalid')
		break
		default:
		form.date.classList.remove('invalid')
		if(form.date.classList.length) break
		form.date.removeAttribute('class')
	}

	switch(true){
		case form.comment.value.includes('"'):
		form.comment.classList.add('invalid')
		break
		default:
		form.comment.classList.remove('invalid')
		if(form.comment.classList.length) break
		form.comment.removeAttribute('class')
	}

	const{resolve,promise}=Promise.withResolvers()
	form.addEventListener('input',resolve)
	await promise
} while(true)
</script>

<script type=module>
const[form]=document.forms
do{
	const{resolve,promise}=Promise.withResolvers()
	form.comment.addEventListener('blur',resolve)
	await promise

	if(form.comment.value.includes('"')){
	} else continue

	if('requestIdleCallback'in window){
		await new Promise(requestIdleCallback)
	}
	alert('「"」は使用できません。(Googleスプレッドシートとの連携の都合上)')
} while(true)
</script>

<script type=module>
const{resolve,promise}=Promise.withResolvers()
addEventListener('pageshow',resolve)
await promise

const[form]=document.forms
do{
	switch(true){
		case form.matches(':has(:not(.貸出,.延長,.返却).invalid)'):
		// 改修 ここから
		case form.matches(':has([value=貸出]:checked):has(.borrow.invalid)'):
		case form.matches(':has([value=貸出]:checked):has(.borrow-or-return.invalid)'):
		case form.matches(':has([value=返却]:checked):has(.return.invalid)'):
		case form.matches(':has([value=返却]:checked):has(.borrow-or-return.invalid)'):
		// 改修 ここから
		form.submitter.disabled=true
		break
		default:
		form.submitter.disabled=false
	}

	const{resolve,promise}=Promise.withResolvers()
	form.addEventListener('input',resolve)
	await promise

	form.submitter.disabled=false
	form.submitter.value='申請'
} while(true)
</script>

<script type=module>
/*
//
let autoinput=false
//

const{resolve,promise}=Promise.withResolvers()
addEventListener('pageshow',resolve)
await promise
if('requestIdleCallback'in window){
	await new Promise(requestIdleCallback)
}
if(confirm('当端末に紐付けられた氏名を入力しますか?')){
	if(document.hasFocus()){
	} else{
		const{resolve,promise}=Promise.withResolvers()
		addEventListener('focus',resolve)
		await promise
	}

	const[form]=document.forms
	try{
		const publicKey={}
		publicKey.challenge=new ArrayBuffer
		publicKey.allowCredentials=[]
		const{response}=await navigator.credentials.get({publicKey})
		form.userName.value=new TextDecoder().decode(response.userHandle)
		form.dispatchEvent(new Event('input'))
		//
		autoinput||=true
		//
	} catch(error){
		alert(error)
	}
}

const options={}
options.method='post'
*/
do{
	const{resolve,promise}=Promise.withResolvers()
	addEventListener('submit',resolve)
	await promise
	if(event.target.method!='post') continue
	event.preventDefault()

	const{submitter,target}=event
	/*
	if(autoinput){
	} else{
		if('requestIdleCallback'in window){
			await new Promise(requestIdleCallback)
		}
		if(confirm('当端末に氏名を紐付けますか?')){
			const publicKey={}
			publicKey.challenge=new ArrayBuffer
			publicKey.pubKeyCredParams=[]
			publicKey.rp={name:'INTLOOPライブラリー'}
			const name=target.userName.value.replace(/^\s+|\s+$/g,'').replace(/\s+/g,' ')
			const id=new TextEncoder().encode(name)
			publicKey.user={name,displayName:name,id}

			try{
				await navigator.credentials.create({publicKey})
			} catch(error){
				alert(error)
				continue
			}
		}
	}
	*/

	submitter.disabled=true
	submitter.value='申請中'
	target.classList.add('posting')

	const payloadSource={}
	payloadSource.digits=target.digits.value
	payloadSource.userName=target.userName.value
	payloadSource.type=target.type.value
	switch(target.type.value){
		case'貸出':
		payloadSource.date=target.date.value
		break
		case'返却':
		payloadSource.date=target.date.value
		payloadSource.comment=target.comment.value
	}
	if(target.withResolvers){
		payloadSource.withResolvers=target.withResolvers.checked
	}

	const options={}
	options.method=target.method
	options.body=JSON.stringify(payloadSource)
	let trial=fetch(target.action,options)
	try{
		await trial
	} catch{
		await new Promise(requestAnimationFrame)
		trial=fetch(target.action,options)
	}
	try{
		const response=await trial
		submitter.value='申請済'
		target.classList.remove('posting')
		if(target.classList.length){
		} else{
			target.removeAttribute('class')
		}
		const text=await response.text()
		if('requestIdleCallback'in window){
			await new Promise(requestIdleCallback)
		}
		alert(text)
	} catch(error){
		submitter.disabled=false
		submitter.value='申請'
		target.classList.remove('posting')
		if(target.classList.length){
		} else{
			target.removeAttribute('class')
		}
		if('requestIdleCallback'in window){
			await new Promise(requestIdleCallback)
		}
		alert(error+'\n\nお手数ですが、清田までご連絡ください。手動で処理いたします。ページを離れていただいて構いません。')
	}
} while(true)
</script>

<form action=https://script.google.com/macros/s/AKfycbx2Iksqz5JihaJKVJakdnP0E6K_15N4bzuEAvXGVaVFmA63BhQVw6pt6VuvZWYzlUWh/exec method=post>
	<style>@scope{
		:not(:where(:focus)):where(.invalid){color:#f00}
		:where(input)/*,:where(select)*/{text-align:center}
		:where(input):where([type=date i]){block-size:calc(2lh - 1em)}
		:where(input):where([type=submit i]):not(:where(:disabled)){cursor:pointer}
		:where(label){display:block}
		:where(textarea){block-size:calc(5lh - 1em);resize:none}

		:where(input):not(:where([type])),:where(input):where([type=date i])/*,:where(select)*/,:where(textarea){background-color:light-dark(#ddd,#222)}

		:where(input):where([type=submit i]){color:light-dark(#fff,#000)}
		:where(input):where([type=submit i]):not(:where(:disabled)){background-color:light-dark(#000,#fff)}
		:where(input):where([type=submit i]):where(:disabled){background-color:light-dark(#555,#aaa)}

		:where(:scope):where(.posting){pointer-events:none}

		/*改修 ここから*/
		:where(input)/*,:where(select)*/,:where(textarea){
			appearance:none;
			border:unset;
			border-radius:calc(.5lh - .5em);
			display:block;
			font:unset;
			inline-size:100%;
			padding-block:calc(.5lh - .5em);
			padding-inline:calc(1lh - 1em)
		}
		/*改修 ここまで*/

		:not(:where(:focus)):where(:invalid):where(:read-write){color:#f00}

		:where(.貸出),:where(.延長),:where(.返却){&:not(
			:where(:scope):has(:where(input):where([name=type]):where([value=貸出]):where(:checked)) :where(.貸出),
			:where(:scope):has(:where(input):where([name=type]):where([value=延長]):where(:checked)) :where(.延長),
			:where(:scope):has(:where(input):where([name=type]):where([value=返却]):where(:checked)) :where(.返却)
		){display:none}}
		/*
		:where(.貸出),:where(.延長),:where(.返却){&:not(
			:where(:scope):has(:where(option):where([value=貸出]):where(:checked)) :where(.貸出),
			:where(:scope):has(:where(option):where([value=延長]):where(:checked)) :where(.延長),
			:where(:scope):has(:where(option):where([value=返却]):where(:checked)) :where(.返却)
		){display:none}}
		*{transition-property:background-color,color}
		:not(:focus){transition-duration:.25s}
		*/
	}</style>
	<label><strong>ISBNまたは雑誌コード</strong>（上12桁）</label>
	<div><style>@scope{
		:where(:scope){padding-block:calc(.5lh - .5em)}
	}</style><input name=digits readonly></div>
	<label><strong>氏名</strong>（姓名間 空白必須）</label>
	<div><style>@scope{
		:where(:scope){font-size:.75em;line-height:calc(1rlh/1em - 1rem/1em + 1)}
	}</style>表記揺れ対策のため、一部の漢字は使用できません。使用できる漢字または平仮名を代用してください。</div>
	<div><style>@scope{
		:where(:scope){padding-block:calc(.5lh - .5em)}
	}</style><input name=userName></div>
	<label><strong>申請種別</strong></label>
	<div>
		<style>@scope{
			:where(:scope){column-gap:calc(1rlh - 1rem);display:flex;padding-block:calc(.5rlh - .5rem)}
			:where(:scope)>:where(label){border-radius:calc(.5lh - .5em);flex-grow:1;inline-size:100%;padding-block:calc(.5lh - .5em);padding-inline:calc(1lh - 1em);text-align:center}
			:where(:scope)>:where(label):not(:has(:where(input):where([type=radio]):where(:checked))){background-color:light-dark(#ddd,#222);cursor:pointer}
			:where(:scope)>:where(label):has(:where(input):where([type=radio]):where(:checked)){background-color:light-dark(#000,#fff);color:light-dark(#fff,#000)}
			:where(:scope)>:where(label)>:where(input){display:none}
		}</style>
		<label><input type=radio name=type value=貸出>貸出</label>
		<label><input type=radio name=type value=延長>延長</label>
		<label><input type=radio name=type value=返却>返却</label>
	</div><!--
	<div><style>@scope{
		:where(:scope){padding-block:calc(.5lh - .5em)}
		:where(option):not(:where([value])){display:none}
	}</style><select name=type required>
		<option>選択してください</option>
		<option value=貸出>貸出</option>
		<option value=延長>延長</option>
		<option value=返却>返却</option>
	</select></div>-->
	<label class=貸出><strong>貸出日</strong></label>
	<label class=返却><strong>返却日</strong></label>
	<div class=貸出&#32;返却><style>@scope{
		:where(:scope){padding-block:calc(.5lh - .5em)}
	}</style><input type=date name=date></div>
	<label class=返却><strong>お薦めコメント</strong>（任意）</label>
	<div class=返却><style>@scope{
		:where(:scope){padding-block:calc(.5lh - .5em)}
	}</style><textarea name=comment placeholder=「"」は使用できません。></textarea></div>
	<div class=貸出&#32;延長&#32;返却><style>@scope{
		:where(:scope){padding-block:calc(.5lh - .5em)}
	}</style><input type=submit name=submitter disabled value=申請></div>
</form>

<!--
<script type=module>
if(Promise.withResolvers){
} else{
	const[{submitter}]=document.forms
	const input=document.createElement('input')
	input.type='hidden'
	input.name='withResolvers'
	input.checked=false
	submitter.parentElement.insertBefore(input,submitter)
}

Promise.withResolvers??=function(){
	const result={}
	result.promise=new this(function(resolve,reject){
		result.resolve=resolve
		result.reject=reject
	})
	return result
}
</script>
-->