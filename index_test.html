<meta name=format-detection content=telephone=no>
<meta name=viewport content=width=device-width>
<title>INTLOOPライブラリー</title>
<link href=style.css rel=stylesheet>
<style>:not(*>*){@media not (prefers-color-scheme:dark){background-color:#000;color-scheme:dark}touch-action:none}</style>

<script src=https://unpkg.com/@zxing/library></script>

<script type=module>
if('withResolvers'in Promise){
} else{
	if('requestIdleCallback'in window){
		await new Promise(requestIdleCallback)
	}
	alert('お手数ですが、他の最新のブラウザーをご利用いただくか、清田へお問い合わせください。')
}
</script>

<script type=module>
const{resolve,promise}=Promise.withResolvers()
addEventListener('pageshow',resolve)
await promise
removeEventListener('pageshow',resolve)
if(event.persisted){
	location=''
}
</script>

<script type=module>
const{video,svg}=window
video.removeAttribute('id')

const reader=new ZXing.BrowserMultiFormatReader
addEventListener('beforeunload',function(){
	reader.reset()
})
try{
	const[{deviceId}]=await reader.listVideoInputDevices()

	const constraints={}
	constraints.video={}
	{
		const{video}=constraints
		video.facingMode='environment'
		video.aspectRatio={max:4/3,min:.75}
		video.brightness=170
		video.contrast=100
		video.saturation=75
		video.exposureMode='continuous'
		video.focusMode='continuous'
		video.whiteBalanceMode='continuous'
	}
	video.srcObject=await navigator.mediaDevices.getUserMedia(constraints)
	await video.play()
	/*
	delete constraints.video
	*/

	/*
	const hints=new Map
	hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,[ZXing.BarcodeFormat.EAN_13])
	*/
	reader.decodeFromVideoDevice(deviceId,video,async function(){
		const[result]=arguments
		if(result){
		} else return

		const{text}=result
		video.pause()

		const codeChunks=[]
		const messageLines=['図書の内容は以下ですか?','']
		switch(code.slice(0,3)){
			case'978':
			case'979':
			const url=new URL('https:api.openbd.jp')
			url.pathname='v1/get'
			url.searchParams.set('isbn',code)
			const response=await fetch(url)
			// 保留 ここから
			let titleUnknown=true
			// 保留 ここまで
			for(const item of await response.json()){
				if(item); else continue
				const{summary}=item
				const{title}=summary
				if(title){
					messageLines.push('題名: '+title)
					// 保留 ここから
					titleUnknown=false
					// 保留 ここまで
				}
				break
			}
			// 保留 ここから
			if(titleUnknown){
				messageLines.push('目視にてISBNをご確認ください。')
			}
			// 保留 ここまで

			codeChunks.push(code.slice(0,3))
			codeChunks.push(code.slice(3,6))
			codeChunks.push(code.slice(6,9))
			codeChunks.push(code.slice(9,12))
			codeChunks.push(code.slice(12,13))
			messageLines.push('ISBN: '+codeChunks.join(' '))
			break

			case'491':
			codeChunks.push(code.slice(0,3))
			codeChunks.push(code.slice(3,4))
			codeChunks.push(code.slice(4,9))
			codeChunks.push(code.slice(9,11))
			codeChunks.push(code.slice(11,12))
			codeChunks.push(code.slice(12,13))
			messageLines.push('雑誌コード: '+codeChunks.join(' '))
		}
		if(confirm(messageLines.join('\n'))){
			location.href='form.html?digits='+code.slice(0,-1)
			await Promise.race('')
		}
	}/*,hints*/)
	location.reload()
	
} catch(error){
	if('requestIdleCallback'in window){
		await new Promise(requestIdleCallback)
	}
	alert(error)
}
</script>

<video id=video playsinline>
	<style>@scope{
		:where(:scope){block-size:100%;inline-size:100%}
		/*position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain*/
	}</style>
</video>
<div><style>@scope{
	:where(:scope){inset-block:calc(1.5rem - .5rlh);inset-inline:1rem;position:absolute;block-size:fit-content;inline-size:fit-content;-webkit-user-select:none;filter:drop-shadow(0 0 .25em light-dark(#fff,#000))}
}</style>裏表紙のバーコードを読み取ってください。</div>