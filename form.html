<meta content=width=device-width name=viewport>
<link href=style.css rel=stylesheet>
<style>
	button,input,textarea{all:unset}
	body{margin-left:auto;margin-right:auto;max-width:calc(640px - 32px);padding:8px 16px}
	button,input,textarea,label:has(input){background:#ddd;margin-top:8px;margin-bottom:8px;padding:8px 16px}
	button,input,textarea{width:calc(100% - 32px)}
	button,input,label:has(input){text-align:center}
	button:not(:disabled),label:has(input){cursor:pointer}
	input[type=date]{display:inline-block;height:calc(1em + 16px)}
	input[type=radio]{display:none}
	button,label:has(input:checked){background:#000;color:#fff}
	button,label:has(input:checked),label:not(:has(input)){font-weight:bold}
	label:has(input){flex-grow:1}
	:disabled{opacity:calc(2/3)}
	#flex{display:flex;column-gap:16px}
</style>
<title>INTLOOPライブラリー 申請フォーム</title>
<form id=form>
	<label>ISBN 上12桁</label>（自動入力）
	<input name=digits readonly>
	<label>氏名</label>（姓名間 空白必須）
	<input name=userName>
	<label>申請種別</label>
	<div id=flex>
		<label><input name=type value=貸出 type=radio>貸出</label>
		<label><input name=type value=延長 type=radio>延長</label>
		<label><input name=type value=返却 type=radio>返却</label>
	</div>
	<label class=borrow>貸出日</label>
	<label class=return>返却日</label>
	<input id=date name=date type=date>
	<label class=return>お薦めコメント（任意）</label>
	<textarea class=return name=comment></textarea>
	<button disabled id=submit></button>
</form>
<script type=module>
	form.digits.value=new URL(location).searchParams.get("digits")
	form.date.value=new Date().toLocaleDateString("sv")
	const decoder=new TextDecoder("sjis")
	decoder.xxx=function(number){
		const array=[]
		while(number){
			array.unshift(--number%0x100)
			number-=number%0x100
			number/=0x100
		}
		return this.decode(new Uint8Array(array))
	}
	let usableLetters=""
    const usableLetterRegExp=/^[^\d\x00-\x1f\x7f-\x9f\uff00-\uffff]$/
	for(let number=1;number<0x10101/*0xee41*/;++number){
		const text=decoder.xxx(number)
		if(usableLetterRegExp.test(text)); else continue
		usableLetters+=text
	}
	const isbnRegExp=/^97[89]\d{9}$/
	const userNameRegExp=/^\s*\S*\s*$/
	const borrowElements=document.querySelectorAll(".borrow")
	const returnElements=document.querySelectorAll(".return")
	oninput=()=>{
		for(const{style}of borrowElements){
			style.display=form.type.value=="貸出"?"":"none"
		}
		for(const{style}of returnElements){
			style.display=form.type.value=="返却"?"":"none"
		}
		date.style.display=form.type.value=="貸出"||form.type.value=="返却"?"":"none"
		submit.disabled=false
		submit.disabled||=!isbnRegExp.test(form.digits.value) 
		submit.disabled||=!form.type.value
		submit.disabled||=userNameRegExp.test(form.userName.value)
		for(const letter of form.userName.value){
			submit.disabled||=!usableLetters.includes(letter)
		}
		submit.disabled||=new Date(form.date.value)>new Date
		submit.innerText="申請"
	}
	submit.onclick=async()=>{
		submit.disabled=true
		submit.innerText="申請中"
		const url="https://script.google.com/macros/s/AKfycbx2Iksqz5JihaJKVJakdnP0E6K_15N4bzuEAvXGVaVFmA63BhQVw6pt6VuvZWYzlUWh/exec"
		const payloadSource={digits:form.digits.value,userName:form.userName.value,type:form.type.value}
		switch(form.type.value){
			case"貸出":
			payloadSource.date=form.date.value
			break
			case"返却":
			payloadSource.date=form.date.value
			payloadSource.comment=form.comment.value
		}
		const response=await fetch(url,{method:"post",body:JSON.stringify(payloadSource)})
		submit.innerText="申請済"
		alert(await response.text())
	}
	oninput()
	if(isbnRegExp.test(form.digits.value)); else{
		await new Promise(setTimeout)
		alert("URLのパラメーター digits が不正です。")
	}
</script>