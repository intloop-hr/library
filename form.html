<meta name=format-detection content=telephone=no>
<meta name=viewport content=width=device-width>
<title>INTLOOPライブラリー 申請フォーム</title>
<link href=style.css rel=stylesheet>
<style>:not(*>*)>:where(body){inline-size:min(640px - 2rlh + 2rem,100% - 2rlh + 2rem);margin-inline:auto;padding-block:calc(.5rlh - .5rem);padding-inline:calc(1rlh - 1rem)}</style>

<script type=module>
const[form]=document.forms
form.digits.value=new URLSearchParams(location.search).get('digits')
if(form.digits.matches(':invalid')){
	if(document.hasFocus()){
	} else{
		const{resolve,promise}=Promise.withResolvers()
		addEventListener('focus',resolve)
		await promise
	}
	do{
		const{resolve,promise}=Promise.withResolvers()
		addEventListener('pageshow',resolve)
		await promise
		if('requestIdleCallback'in window){
			await new Promise(requestIdleCallback)
		}
		alert('URLのパラメーター digits が不正です。')
		history.back()
	} while(true)
}
</script>

<script type=module>
const usableCharacters=function(){
	const decoder=new TextDecoder('sjis')
	let result='\'\\-A-Za-z々あいうえお-ろわ-んゝゞァ-ロワ-ヴーヽヾ'
	for(let number=0x8800;number<0xec00;++number){
		const array=[]
		let number_2=number
		while(number_2){
			array.unshift(--number_2%0x100)
			number_2>>=0x8
		}
		const uint8Array=new Uint8Array(array)
		const text=decoder.decode(uint8Array)
		if(text.codePointAt()<0x4e00) continue
		if(text.codePointAt()>=0xa000) continue
		result+=text
	}
	return result
}()
const[form]=document.forms
form.userName.pattern=`[ 　${usableCharacters}]*[${usableCharacters}]+[ 　]+[${usableCharacters}]+[ 　${usableCharacters}]*`
</script>

<script type=module>
const[form]=document.forms
form.date.max=new Date().toLocaleDateString('sv')
</script>

<script type=module>
const{resolve,promise}=Promise.withResolvers()
addEventListener('pageshow',resolve)
await promise
const[form]=document.forms
form.date.value||=new Date().toLocaleDateString('sv')
do{
	switch(form.type.value){
		case'貸出':
		form.date.disabled&&=false
		form.comment.disabled||=true
		break
		case'返却':
		form.date.disabled&&=false
		form.comment.disabled&&=false
		break
		default:
		form.date.disabled||=true
		form.comment.disabled||=true
	}
	form.submitter.value='申請'
	if(form.matches(':valid')){
		form.submitter.disabled&&=false
	}
	if(form.matches(':invalid')){
		form.submitter.disabled||=true
	}
	const{resolve,promise}=Promise.withResolvers()
	form.addEventListener('input',resolve)
	await promise
} while(true)
</script>

<script type=module>
do{
	const{resolve,promise}=Promise.withResolvers()
	addEventListener('submit',resolve)
	await promise
	if(event.target.method!='post') continue
	event.preventDefault()
	const{submitter,target}=event

	submitter.disabled=true
	submitter.value='申請中'
	target.classList.add('posting')

	const options={}
	options.method=target.method
	//options.mode='no-cors'
	// 確認 ここから
	const entries=new FormData(target).entries()
	const object=Object.fromEntries(entries)
	options.body=JSON.stringify(object)
	// 確認 ここまで
	let trial=fetch(target.action,options)
	try{
		await trial
	} catch(error){
		if('requestIdleCallback'in window){
			await new Promise(requestIdleCallback)
		}
		alert(error)
		await new Promise(requestAnimationFrame)
		trial=fetch(target.action,options)
	}
	const response=await trial
	submitter.value='申請済'
	target.classList.remove('posting')
	if(target.classList.length){
	} else{
		target.removeAttribute('class')
	}
	const text=await response.text()
	if('requestIdleCallback'in window){
		await new Promise(requestIdleCallback)
	}
	alert(text)
} while(true)
</script>

<form action=https://script.google.com/macros/s/AKfycbx2Iksqz5JihaJKVJakdnP0E6K_15N4bzuEAvXGVaVFmA63BhQVw6pt6VuvZWYzlUWh/exec method=post>
	<style>@scope{
		:where(input)/*,:where(select)*/,:where(textarea){all:unset;background-color:light-dark(#ddd,#222);border-radius:calc(.5lh - .5em);box-sizing:border-box;cursor:revert;display:block;padding-block:calc(.5lh - .5em);padding-inline:calc(1lh - 1em);min-block-size:1lh;inline-size:100%}

		:where(input)/*,:where(select)*/,:where(textarea){&:not(:where(:focus)):where(:invalid){color:#f00}}
		:where(input)/*,:where(select)*/{text-align:center}
		:where(input):where([type=date i]){block-size:calc(2lh - 1em)}
		::-webkit-calendar-picker-indicator{cursor:pointer}
		:where(input):where([type=submit i]):not(:where(:disabled)){cursor:pointer}
		:where(label){display:block}
		:where(textarea){resize:none}

		:where(input):where([type=submit i]){color:light-dark(#fff,#000)}
		:where(input):where([type=submit i]):not(:where(:disabled)){background-color:light-dark(#000,#fff)}
		:where(input):where([type=submit i]):where(:disabled){background-color:light-dark(#555,#aaa)}

		:where(:scope):where(.posting){pointer-events:none}

		:where(.貸出),:where(.延長),:where(.返却){&:not(
			:where(:scope):has(:where(input):where([name=type i]):where([value=貸出]):where(:checked)) :where(.貸出),
			:where(:scope):has(:where(input):where([name=type i]):where([value=延長]):where(:checked)) :where(.延長),
			:where(:scope):has(:where(input):where([name=type i]):where([value=返却]):where(:checked)) :where(.返却)
		){display:none}}
		:where(input):where([type=submit i]):not(
			:where(:scope):has(:where(input):where([name=type i]):where([value=貸出]):where(:checked)) *,
			:where(:scope):has(:where(input):where([name=type i]):where([value=延長]):where(:checked)) *,
			:where(:scope):has(:where(input):where([name=type i]):where([value=返却]):where(:checked)) *
		){display:none}
		/*
		:where(.貸出),:where(.延長),:where(.返却){&:not(
			:where(:scope):has(:where(option):where([value=貸出]):where(:checked)) :where(.貸出),
			:where(:scope):has(:where(option):where([value=延長]):where(:checked)) :where(.延長),
			:where(:scope):has(:where(option):where([value=返却]):where(:checked)) :where(.返却)
		){display:none}}
		*{transition-property:background-color,color}
		:not(:focus){transition-duration:.25s}
		*/
	}</style>
	<label><strong>ISBNまたは雑誌コード</strong>（上12桁）</label>
	<div><style>@scope{
		:where(:scope){padding-block:calc(.5lh - .5em)}
	}</style><input name=digits readonly required pattern=(97[89]|491)\d{9}></div>
	<label><strong>氏名</strong>（姓名間 空白必須）</label>
	<div><style>@scope{
		:where(:scope){font-size:.75em;line-height:calc(1rlh/1em - 1rem/1em + 1)}
	}</style>表記揺れ対策のため、一部の漢字は使用できません。使用できる漢字または平仮名を代用してください。</div>
	<div><style>@scope{
		:where(:scope){padding-block:calc(.5lh - .5em)}
	}</style><input name=userName required></div>
	<label><strong>申請種別</strong></label>
	<div>
		<style>@scope{
			:where(:scope){column-gap:calc(1lh - 1em);display:flex;padding-block:calc(.5lh - .5em)}
			:where(:scope)>:where(label){border-radius:calc(.5lh - .5em);flex-grow:1;padding-block:calc(.5lh - .5em);padding-inline:calc(1lh - 1em);min-block-size:1lh;text-align:center;-webkit-user-select:none}
			:where(:scope)>:where(label)>:where(input):where([name=type i]){display:none}
			/*iOS Safariにて、:scopeの子要素:checkedを指定できない*/
			:where(label):not(:has(:where(input):where([name=type i]):where(:checked))){background-color:light-dark(#ddd,#222);cursor:pointer}
			:where(label):has(:where(input):where([name=type i]):where(:checked)){background-color:light-dark(#000,#fff);color:light-dark(#fff,#000)}
		}</style>
		<label><input type=radio name=type value=貸出>貸出</label>
		<label><input type=radio name=type value=延長>延長</label>
		<label><input type=radio name=type value=返却>返却</label>
		<!--
		<style>@scope{
			:where(:scope){padding-block:calc(.5lh - .5em)}
			:where(option):not(:where([value])){display:none}
		}</style>
		<select name=type required>
			<option>選択してください</option>
			<option value=貸出>貸出</option>
			<option value=延長>延長</option>
			<option value=返却>返却</option>
		</select>
		-->
	</div>
	<label class=貸出><strong>貸出日</strong></label>
	<label class=返却><strong>返却日</strong></label>
	<div class=貸出&#32;返却><style>@scope{
		:where(:scope){padding-block:calc(.5lh - .5em)}
	}</style><input type=date name=date required></div>
	<label class=返却><strong>お薦めコメント</strong>（任意）</label>
	<div class=返却><style>@scope{
		:where(:scope){padding-block:calc(.5lh - .5em)}
	}</style><textarea name=comment rows=4></textarea></div>
	<div><style>@scope{
		:where(:scope){padding-block:calc(.5lh - .5em)}
	}</style><input type=submit name=submitter disabled value=申請></div>
</form>